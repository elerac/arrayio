# arrayio

**arrayio** provides array I/O functionality tailored for visual media applications. It facilitates image and metadata handling in both human-readable and machine-parsable formats with powerful features such as parallel processing for multiple arrays and non-blocking saving.

## Motivation

In computer vision and graphics, we often working with multiple images and their associated metadata (e.g., camera parameters, timestamps, etc.) that are either captured with cameras or generated by rendering. A common challenge is saving and loading these images along with their metadata. **arrayio** offers a simple and effective solution to this problem.

1. **Accessibility**: While formats like HDF5 or NPZ offer flexibility for handling images with metadata, they are incompatible with standard image viewers and require specialized tools to access the data. This makes it difficult for users to quickly view images and their metadata. arrayio separates image data and metadata into standard image files (like PNG, EXR) and JSON files, respectively. This allows users to open images in standard viewers and inspect metadata using any text editor.

2. **Performance**: Handling large numbers of images with lossless compression can be slow the i/o operations. arrayio supports parallel processing for saving and loading multiple images, significantly speeding up the process. It also supports non-blocking saving, allowing you to continue processing while images are being saved in the background.

3. **Code Simplicity**: arrayio provides a simple and intuitive API, `save` and `load`, that abstracts away the complexities of handling different situations, such as single image or multiple images, with or without metadata, and data type (uint8, uint16, float32, etc.). These functions automatically detect the appropriate file format based on the data type and filename, making it easy to save and load images without worrying about the underlying details.

![motivation](docs/motivation.jpg)

## Installation

```bash
pip install git+https://github.com/elerac/arrayio.git
```

## Example Usage

### Single Image

```python
import numpy as np
import arrayio

image = np.random.randint(0, 255, (480, 640, 3), dtype=np.uint8)
metadata = {
    "exposure_time": 0.01,
    "camera_matrix": np.array([[1000, 0, 320], [0, 1000, 240], [0, 0, 1]]),
    "timestamp": "2025-06-25T12:00:00Z"
}

arrayio.save("myimage.png", image, **metadata)
# -> Saved as myimage.png and myimage.json

image, metadata = arrayio.load("myimage.png")
# -> metadata is loaded from myimage.json
```

### Automatic Fileformat Detection

```python
import numpy as np
import arrayio

img_u8 = np.random.randint(0, 255, (480, 640, 3), dtype=np.uint8)
arrayio.save("myimage_u8", img_u8)
# -> Saved as myimage_u8.png

img_u16 = np.random.randint(0, 65535, (480, 640, 3), dtype=np.uint16)
arrayio.save("myimage_u16", img_u16)
# -> Saved as myimage_u16.png

img_f32 = np.random.rand(480, 640, 3).astype(np.float32)
arrayio.save("myimage_f32", img_f32)
# -> Saved as myimage_f32.exr

img_f64 = np.random.rand(480, 640, 3).astype(np.float64)
arrayio.save("myimage_f64", img_f64)
# -> Saved as myimage_f64.npy

vector = np.linspace(0, 1, 100)
arrayio.save("myvector", vector)
# -> Saved as myvector.npy

tensor = np.random.rand(10, 10, 10)
arrayio.save("mytensor", tensor)
# -> Saved as mytensor.npy
```

### Multiple Images (Specifying All Filenames)

```python
import numpy as np
import time
import arrayio

list_image = []
list_filename = []
list_timestamp = []
list_number = []
for i in range(20):
    image = np.random.randint(0, 255, (480, 640, 3), dtype=np.uint8)
    list_image.append(image)
    list_timestamp.append(time.time())
    list_number.append(i)
    list_filename.append(f"multi/myimage_{i}.png")

arrayio.save(list_filename, list_image, timestamp=list_timestamp, number=list_number)
# -> Saved under multi/
# as myimage_0.png, myimage_1.png, ..., myimage_19.png
# and metadata in multi/myimage_0.json, multi/myimage_1.json, ..., multi/myimage_19.json

list_image, metadata = arrayio.load(list_filename)
list_timestamp = metadata["timestamp"]
list_number = metadata["number"]
```

### Multiple Images (Specifying a Directory)

```python
import numpy as np
import time
import arrayio

list_image = []
list_timestamp = []
list_number = []
for i in range(20):
    image = np.random.randint(0, 255, (480, 640, 3), dtype=np.uint8)
    list_image.append(image)
    list_timestamp.append(time.time())
    list_number.append(i)

arrayio.save("multi2", list_image, timestamp=list_timestamp, number=list_number)
# -> Saved under multi2/
# as 0.png, 1.png, ..., 19.png
# and metadata in 0.json, 1.json, ..., 19.json

list_image, metadata = arrayio.load("multi2")
list_timestamp = metadata["timestamp"]
list_number = metadata["number"]
```

### Non-blocking Saving

```python
import time
import numpy as np
import arrayio

# Basic saving
t = time.time()
for i in range(20):
    image = np.random.rand(960, 1280, 3).astype(np.float32)
    arrayio.save(f"non_blocking/false/myimage_{i}", image)
print(f"{time.time() - t:.2f} seconds (blocking)")
# -> 7.65 seconds (blocking)

# Non-blocking saving
t = time.time()
for i in range(20):
    image = np.random.rand(960, 1280, 3).astype(np.float32)
    arrayio.save(f"non_blocking/true/myimage_{i}", image, nonblock=True)
print(f"{time.time() - t:.2f} seconds (non-blocking)")
# -> 0.44 seconds (non-blocking)

arrayio.wait_saves()  # Ensure all non-blocking saves are completed
```
